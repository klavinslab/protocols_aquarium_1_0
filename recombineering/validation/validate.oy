base_dir = "recombineering/validation/"
cloning_base = "cloning/workflow/"

argument
  plates: sample("E coli strain") array, "overnights to test"
  f_pri: sample("Primer"), "forward assay primer"
  r_pri: sample("Primer"), "reverse assay primer"
  n_col: number, "number of colonies to pick, (eg 2)"
  enzyme_id: samples("Enzyme"), "Physion HF MM"
end

place parse_args
  marked: true
end

place pick_col 
  protocol: base_dir+"pick_colonies.pl"
  argument
    plates: plates
    n_col: n_col
  end
  group: technicians
  start: now()
end

place boil_cells
	protocol: base_dir+"boil_cells.pl"	
  argument
    pf: f_pri
    pr: r_pri
  end
	start: hours(16)
	window: days(1)
	group: technicians
end

wire (pick_col, "tubes") => (boil_cells, "overnights") 

place pcr
  protocol: cloning_base + "010_PCR.pl"
  argument
    initials: "REC"
    enzyme_id: enzyme_id
    tanneal: 65
  end
  start: now()
  window: days(1)
  group: technicians
end
wire (boil_cells, "fwd_pri") => (pcr,"forward_ids")
wire (boil_cells, "rev_pri") => (pcr,"reverse_ids")
wire (boil_cells, "gen_preps") => (pcr,"template_ids")


# forward transitions
transition [parse_args] => [make_log_phase] when true 
  do
    #tsk = tasks("recombineering", "ready")
    params = {plates: plates, f_primer: f_pri, r_primer: r_pri, n_col: n_col}
  end
end

transition [make_log_phase] => [finish_log_phase] when !error(0) && completed(0) end 
transition [finish_log_phase] => [heat_shock] when !error(0) && completed(0) end

transition [heat_shock] => [quick_comp] when !error(0) && completed(0) end 
transition [quick_comp] => [transform] when !error(0) && completed(0) end 
transition [transform] => [plate] when !error(0) && completed(0) end 
transition [plate] => [] when !error(0) && completed(0) 
  do
    useless_variable = set_task_status(choosen_task,"done")
  end
end

# remaining reverse transitions
transition [make_log_phase] => [make_log_phase] when error(0) end 
transition [finish_log_phase] => [make_log_phase] when error(0) end 

transition [heat_shock] => [heat_shock] when error(0) end 
transition [quick_comp] => [quick_comp] when error(0) end 
transition [transform] => [transform] when error(0) end 
transition [plate] => [plate] when error(0) end
#transition [boil_cells] => [boil_cells] when error(0) end
#transition [pcr_prepare] => [pcr_prepare] when error(0) end
#transition [pour_gels] => [pour_gels] when error(0) end
#transition [run_gels] => [run_gels] when error(0) end
#transition [image_gels] => [image_gels] when error(0) end

